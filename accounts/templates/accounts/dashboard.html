{% load static %}
{% load humanize %}
{% load widget_tweaks %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Dashboard - Starlink Bank</title>

  <link href="{% static 'img/favicon2.ico' %}" rel="icon">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="{% static 'vendor/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
  <link href="{% static 'vendor/bootstrap-icons/bootstrap-icons.css' %}" rel="stylesheet">
  <link href="{% static 'css/main.css' %}" rel="stylesheet">

  <style>
    :root {
      --brand: #0ea2bd;
      --accent-dark: #0b94a5;
      --muted: #6c757d;
      --card-bg: #ffffff;
    }

    body {
      background-color: #f4f6fa;
      font-family: 'Roboto', sans-serif;
    }

    /* Header */
    .header {
      background-color: var(--brand);
      color: #fff;
    }
    .header .sitename { font-weight: 700; margin: 0; color: #fff; }

    /* Top controls */
    .top-controls .btn { margin-left: 0.5rem; }

    /* Sidebar */
    .sidebar {
      background-color: #fff;
      border-right: 1px solid #e9ecef;
      padding: 20px;
      min-height: 100vh;
    }
    .sidebar .nav-link { color: #333; transition: all .2s; border-radius: 6px; padding: .5rem .75rem; }
    .sidebar .nav-link:hover { background-color: #f8f9fa; }

    /* Account box */
    .account-box {
      background: linear-gradient(90deg, var(--brand), var(--accent-dark));
      color: #fff;
      padding: 20px 22px;  /* Slightly reduced padding to bring mini cards closer */
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(14,162,189,0.08);
    }
    .account-box h5 { color: rgba(255,255,255,0.9); margin-bottom: .25rem; }
    .account-box h2 { font-size: 2.2rem; margin: 0.25rem 0 0.5rem; }

    /* Action buttons */
    .action-buttons {
      margin-top: 0.75rem;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.5rem;
    }
    .action-buttons .btn { border-radius: 8px; flex: 1 1 140px; } /* responsive min width */
    .action-buttons .btn.disabled { opacity: .7; pointer-events: none; }

    /* Mini cards */
    .mini-card { background: var(--card-bg); border-radius: 8px; padding: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.03); }

    /* Mini chat */
    .mini-chat {
      min-height: 150px;
      max-height: 220px;
      overflow-y: auto;
      padding: 12px;
      border-radius: 8px;
      background: linear-gradient(180deg,#fafafa,#fff);
    }
    .chat-bubble {
      display: inline-block;
      max-width: 78%;
      padding: 10px 14px;
      border-radius: 18px;
      margin-bottom: 10px;
      word-wrap: break-word;
      font-size: .95rem;
      position: relative;
      line-height: 1.3;
      clear: both;
    }
    .chat-bubble.user {
      background: var(--brand);
      color: #fff;
      float: right;
      border-bottom-right-radius: 4px;
      text-align: right;
    }
    .chat-bubble.admin {
      background: #f1f3f5;
      color: #212529;
      float: left;
      border-bottom-left-radius: 4px;
      text-align: left;
    }
    .chat-meta { display: block; font-size: .75rem; color: var(--muted); margin-top: 6px; }

    /* Chat badge */
    .chat-badge {
      position: absolute;
      top: -6px;
      right: -8px;
      font-size: .65rem;
      padding: .35rem .45rem;
      border-radius: 999px;
    }

    /* Footer */
    .footer { font-size: .9rem; }

    /* Responsive */
    @media (max-width: 991px) { .sidebar { display: none; } }
    @media (max-width: 576px) {
      .account-box h2 { font-size: 1.5rem; }
      .chat-bubble { max-width: 90%; }
      .action-buttons { justify-content: center; }
    }
  </style>
</head>

<body class="dashboard-page">

  <!-- Header -->
  <header class="header py-3 sticky-top shadow-sm">
    <div class="container-fluid d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center">
        <button class="btn btn-outline-light d-lg-none me-3" id="menuToggle">
          <i class="bi bi-list fs-4"></i>
        </button>
        <h1 class="sitename mb-0"><a style="color:white" href="{% url 'index' %}">Starlink Bank</a></h1>
      </div>

      <div class="d-flex align-items-center top-controls">
        <span class="me-3 d-none d-sm-inline">Hello, <strong>{{ request.user.first_name }}</strong> ðŸ‘‹</span>

        <div style="position:relative;">
          <a href="{% url 'user_messages' %}" class="btn btn-outline-light btn-sm d-flex align-items-center">
            <i class="bi bi-chat-dots me-2"></i> Chat Support
          </a>
          {% if unread_messages %}
            <span id="message-badge" class="badge bg-danger chat-badge">{{ unread_messages }}</span>
          {% endif %}
        </div>

        <a class="btn btn-light btn-sm ms-3" href="{% url 'logout' %}">Logout</a>
      </div>
    </div>
  </header>

  <!-- Main content -->
  <div class="container-fluid">
    <div class="row gx-4 py-4">

      <!-- Sidebar -->
      <aside class="col-lg-2 sidebar d-none d-lg-block">
        <div class="mini-card text-center mb-3">
          <strong>{{ request.user.first_name }} {{ request.user.last_name }}</strong><br>
          <small class="text-muted">Customer</small>
          <div class="mt-2"><span class="badge bg-success">KYC Verified</span></div>
        </div>

        <nav class="nav flex-column">
          <a class="nav-link" href="#">Dashboard</a>
          <a class="nav-link" href="{% url 'transaction_history' %}">Transactions</a>
          <a class="nav-link" href="#">Cards</a>
          <a class="nav-link" href="#">Local Transfer</a>
          <a class="nav-link" href="#">International Wire</a>
        </nav>
      </aside>

      <!-- Main panel -->
      <main class="col-lg-10">

        <!-- Account box -->
        <div class="account-box mb-3">
          <div class="d-sm-flex justify-content-between align-items-start">
            <div>
              <h5>Available Balance</h5>
              <h2>${{ account.balance|floatformat:2|intcomma }} USD</h2>
              <p class="mb-0">Account Number: <strong>{{ account.account_number }}</strong></p>
              <p class="mb-0 mt-1"><span class="badge bg-light text-dark">{{ account.status }}</span></p>
            </div>

            <div class="mt-3 mt-sm-0 text-sm-end">
              {% if not request.user.is_active %}
                <div class="alert alert-danger mb-2">
                  âš  Your account is currently <strong>frozen</strong>. Please contact support.
                </div>
              {% endif %}

              <div class="action-buttons">
                {% if account.status == 'Frozen' %}
                  <div class="alert alert-danger text-center p-3 rounded shadow-sm  mb-2">
                    âš  Your account is currently <strong>FROZEN.</strong>.<br>
                    <a href="{% url 'user_messages' %}" class="btn btn-outline-light mt-2 px-4">
                      Contact Customer Care
                    </a>
                  </div>

                  <a class="btn btn-primary disabled" href="#"><i class="bi bi-arrow-left-right me-1"></i> Transfer</a>
                  <a class="btn btn-success disabled" href="#"><i class="bi bi-wallet2 me-1"></i> Deposit</a>
                  <a class="btn btn-warning disabled" href="#"><i class="bi bi-cash-coin me-1"></i> Apply for loan</a>
                {% else %}
                  <a href="{% url 'transfer_money' %}" class="btn btn-primary"><i class="bi bi-arrow-left-right me-1"></i> Transfer</a>
                  <a href="{% url 'deposit' %}" class="btn btn-success"><i class="bi bi-wallet2 me-1"></i> Deposit</a>
                  <a href="#" class="btn btn-light"><i class="bi bi-plus-circle me-1"></i> Apply for loan</a>
                {% endif %}

                <a href="#" class="btn btn-warning"><i class="bi bi-credit-card me-1"></i> Request Card</a>
                <a href="{% url 'set_transaction_pin' %}" class="btn btn-primary btn-pin"><i class="bi bi-key me-1"></i> Set / Change Transaction PIN</a>
              </div>
            </div>
          </div>
        </div>

        <!-- Mini cards row -->
        <div class="row g-3 mb-4">

          <!-- Recent transactions -->
          <div class="col-md-6 col-lg-4">
            <div class="mini-card">
              <h6 class="mb-1">Recent transactions</h6>
              <p class="mb-0 text-muted">Latest 5 transactions</p>
              <hr>
              {% for t in transactions|slice:":5" %}
                <div class="d-flex justify-content-between small py-1">
                  <div>{{ t.description|truncatechars:30 }}</div>
                  <div class="text-end">${{ t.amount|floatformat:2|intcomma }}</div>
                </div>
              {% empty %}
                <p class="text-muted small mb-0">No recent transactions</p>
              {% endfor %}
              <div class="mt-2"><a href="{% url 'transaction_history' %}" class="small">View all</a></div>
            </div>
          </div>

          <!-- Card requests -->
          <div class="col-md-6 col-lg-4">
            <div class="mini-card">
              <h6 class="mb-1">Card requests</h6>
              <p class="mb-0 text-muted">Latest requests</p>
              <hr>
              {% for c in card_requests|slice:":5" %}
                <div class="d-flex justify-content-between small py-1">
                  <div>{{ c.date_requested|date:"M d" }}</div>
                  <div>
                    {% if c.status == 'approved' %}
                      <span class="badge bg-success">Approved</span>
                    {% elif c.status == 'pending' %}
                      <span class="badge bg-warning text-dark">Pending</span>
                    {% else %}
                      <span class="badge bg-danger">Rejected</span>
                    {% endif %}
                  </div>
                </div>
              {% empty %}
                <p class="text-muted small mb-0">No card requests</p>
              {% endfor %}
            </div>
          </div>

          <!-- Mini chat -->
          <div class="col-md-12 col-lg-4">
            <div class="mini-card">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                  <h6 class="mb-0">Messages</h6>
                  <small class="text-muted">Recent conversation</small>
                </div>
                <a class="view-all-messages" href="{% url 'user_messages' %}">View all â†’</a>
              </div>

              <div class="mini-chat" id="miniChat">
                {% for msg in messages|slice:":5" %}
                  {% if msg.sender == 'User' %}
                    <div class="chat-bubble user">
                      {{ msg.content|linebreaksbr }}
                      <span class="chat-meta">{{ msg.created_at|date:"M d, H:i" }}</span>
                    </div>
                  {% else %}
                    <div class="chat-bubble admin">
                      {{ msg.content|linebreaksbr }}
                      <span class="chat-meta">{{ msg.created_at|date:"M d, H:i" }}</span>
                    </div>
                  {% endif %}
                {% empty %}
                  <p class="text-muted small mb-0">No messages yet. Use Chat Support to contact us.</p>
                {% endfor %}
              </div>

              <div class="mt-2 text-end">
                <a href="{% url 'user_messages' %}" class="btn btn-sm btn-outline-primary">Open Chat</a>
              </div>
            </div>
          </div>

        </div>
      </main>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer bg-dark text-light text-center py-3 mt-4">
    <div class="container">
      <p class="mb-0">Â© {{ now|date:"Y" }} Starlink Bank. All Rights Reserved</p>
    </div>
  </footer>

  <audio id="newMessageSound" src="{% static 'audio/notification.mp3' %}" preload="auto"></audio>

  <script src="{% static 'vendor/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
  <script>
    const menuToggle = document.getElementById("menuToggle");
    const mobileSidebar = document.getElementById("mobileSidebar");
    const overlay = document.getElementById("overlay");
    const closeSidebar = document.getElementById("closeSidebar");
    if(menuToggle) menuToggle.addEventListener("click",()=>{mobileSidebar.classList.toggle("active");overlay.classList.toggle("active");});
    if(overlay) overlay.addEventListener("click",()=>{mobileSidebar.classList.remove("active");overlay.classList.remove("active");});
    if(closeSidebar) closeSidebar.addEventListener("click",()=>{mobileSidebar.classList.remove("active");overlay.classList.remove("active");});

    const badge = document.getElementById('message-badge');
    let lastUnread = badge ? parseInt(badge.textContent || '0',10) : 0;
    async function checkNewMessages() {
      if(!badge) return;
      try {
        const res = await fetch("{% url 'unread_messages_count' %}");
        if(!res.ok) return;
        const data = await res.json();
        const count = data.unread_count || 0;
        badge.textContent = count > 0 ? count : '';
        badge.style.display = count>0?'inline-block':'none';
        if(count>lastUnread) document.getElementById('newMessageSound').play().catch(()=>{});
        lastUnread = count;
      } catch(e){ console.warn(e); }
    }
    setInterval(checkNewMessages,10000);
  </script>

</body>
</html>